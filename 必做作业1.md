###### `思考`：看起来进行了很多适应性调整的常用公式，是不是适合这题目的要求？

<img src="C:\Users\88450\AppData\Roaming\Typora\typora-user-images\image-20211005183925834.png" alt="image-20211005183925834" style="zoom:50%;" />

- 不适合。1.这个公式适用于用一个查询语句匹配所有文档的情况，这样查询语句本身长度不会对结果的排序产生影响，因而可以不对查询语句做归一化。但题目要求计算所有文本之间的两两相似性，需要所有向量都做归一化，不同查询结果之间才具有可比性；2.这个公式采用取对数的方式计算词频，这对于文档这样的长文本是合适的，但本题目的语料都是一个句子这样的短文本，很多词项的词频都是1或2，对词频取对数会大大降低词项间的差异性，可以考虑使用词项在句子中的占比来计算词频，除法计算也比对数计算简单一些。

- ###### 拟定公式：
  
  $$
  \sum_{w\in d_1\cap d_2} \frac{tf(w,d_1)tf(w,d_2)(lg(\frac{N}{df(w)})+1)^2}{|d_1| |d_2|}
  $$
  

###### `代码地址`：

###### `具体步骤`：

- ###### 对文本进行预处理：

  > - 使用gbk格式解码。
  >
  > - 将文本中的词性标识去掉，只保留纯文本。其中词性标识用空格代替，之后以空格作为分词依据。
  >
  > - 预处理代码：pre_processing.py。
  
- ###### 进行文本之间两两相似度计算：

  > - 遍历所有文本，以空格分词，统计所有词项生成词项-文本号倒排索引，索引项中保存该文本中该词项的输入次数。
  > - 生成一个三角阵用来存储向量积，初始值为全0。
  > - 遍历上述倒排索引，将索引项的值替换为tf-idf值，其中，每个词项的idf值只需要计算一次，将索引项之间的乘积加到三角阵的对应单元中，计算每个文本的长度并保存。
  > - 上述遍历完成后，三角阵中存储了没有归一化的向量积，遍历一遍三角阵，将其中元素除以两个对应向量的模，进行归一化即得到结果。
  > - 相似度计算代码：similarity_computing.py。
  > - 运行时间：2572.4s 。
  
- ###### 优化分析：

  > - 对于索引的生成和向量积的计算，逻辑上将他们分离成两个步骤会更加清晰。这里放到一次遍历中，可以增加时间和空间局部性，从而加快访存速度。
  >
  > - 查看系统资源发现，cpu的利用率维持在20-30%，内存利用率在90+%，磁盘利用率在30%左右，可见内存成为性能瓶颈，需要进行页面换入换出，可以使用多线程，在页面调度时利用空闲的cpu。
  >
  > - 通过程序输出发现，构建索引是很快的，主要时间花费在计算两两相似性上，毕竟需要执行$O(n^2)$次向量积，但向量积的计算之间互不相关，因此具有很好的可并行性。
  >
  > - 进一步分析，使用倒排索引时，同一个word对应多个文本，可能造成对三角阵中多个区域的修改，这样若使用多线程就必须加锁，否则可能造成结果不正确。但是加锁会带来时间开销，且会降低并行度。因此，考虑使用正排索引，利用一个线程来计算若干文本与其他文本的相似度，这个线程只修改该三角阵中这些文本对应的行，不影响其他行，不需要加锁。
  >
  > - 并行计算代码：parallel_computing.py。
  >
  > - 运行时间：2051.5s。
  >
  > - 运行时间分析：并行时使用了16个线程，但机器本身是8核的，理论上最多能加速到8倍，但实际上正排索引会加大遍历的开销，并且并行计算使得时空局部性降低，增加了页面调度的次数，导致实际的加速比只有1.26。
  >
  > - 内存优化：使用正排索引后，遍历时相似度三角阵可以一行一行的计算完成，互不干扰，所以实际上不用再构造一个三角阵来存储，每计算一行就将这行输出到结果文件即可，这样可以大大减少内存占用。只是在使用多线程计算时需要注意输出顺序。
  >
  > - 内存优化代码：imp_parallel_computing.py。
  >
  > - 运行时间：1612.2s。

- ###### 正确性检验：

  > 在生成的三角阵中，随机选取一行，选出与这行相似度最高的若干行，从原数据中取出对应句子进行比较，查看相似度。
  >
  > 这里选取了原文中第18行文本进行匹配（该行文本较短，易于观察结果），匹配结果如下（按相似度降序排列）：
  >
  > ![image-20211017100326797](C:\Users\88450\AppData\Roaming\Typora\typora-user-images\image-20211017100326797.png)
  >
  > 可以看到，原文出现在第一行，相似度最高，之后的句子中按词项的匹配度降序排列，结果符合预期。
  >
  > 正确性检验代码：verify.py。

